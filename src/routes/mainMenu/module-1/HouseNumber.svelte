<script lang="ts">
import YouTubeTemplate from '$lib/components/YouTubeTemplate.svelte';
import { audioStore } from '$lib/stores/audioStore';
import { createEventDispatcher } from 'svelte';

const dispatch = createEventDispatcher();

// Props
export let progressId: string;
export let nextButtonText: string = "Next";

const script = [
  { 
    text: "The House Number column contains a unique ID number for each of the commercials. This is how the MC identifies which ad you're referring to. Since one advertiser, like Geico for example, can have several different ads running during the same program, the House Number is key for identifying which specific commercial you are referencing.", 
    audio: '/audio/module-1/07-house-number/module1_housenumber_combined.mp3?v=' + Date.now(),
    image: '/images/module-1/house-number/HouseNumberscreen.png?v=' + Date.now()
  }
];

const videoInfo = {
  title: 'House Number',
  description: 'Learn why House Numbers are important for identifying commercials.'
};

// Track completion
$: audioState = $audioStore;
let isComplete = false;

// Check if user has reached the end of the module - multiple conditions
$: if (!isComplete && audioState.currentIndex === script.length - 1) {
  // Condition 1: Progress-based completion
  if (audioState.progress >= 99) {
    isComplete = true;
    dispatch('moduleCompleted', { submoduleIndex: 7 });
  }
  // Condition 2: Audio finished playing
  else if (!audioState.isPlaying && audioState.progress > 0) {
    isComplete = true;
    dispatch('moduleCompleted', { submoduleIndex: 7 });
  }
  // Condition 3: User has been on last clip for a while
  else if (audioState.progress >= 99) {
    isComplete = true;
    dispatch('moduleCompleted', { submoduleIndex: 7 });
  }
}

function goNext() {
  dispatch('navigateToNextSubmodule');
}

function goToQuiz() {
  dispatch('navigateToQuiz');
}
</script>

<YouTubeTemplate script={script} title={videoInfo.title} onNextSubmodule={goNext} completionButtonText="📝 Take Quiz" onCompletionButtonClick={goToQuiz} progressId={progressId} nextButtonText={nextButtonText} /> 